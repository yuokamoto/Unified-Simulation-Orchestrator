# 5. Simulation Master と ノード設計

## Simulation Master の目的と位置づけ

**Simulation Master** は、主に **分散シミュレーション（Distributed Simulation）** を実現するための中核コンポーネントである。  
複数のシミュレーションノード（SimPy, Gazebo, Mujoco, Genesis, Unreal, Isaac など）を複数サーバーに分散して稼働させ、  
時間と状態を同期しつつ、統合的に管理することを主目的とする。

一方で、**Single Mode（単一ノード・単一マシンでの動作）** では、多くの機能が不要であり、  
簡略化されたプロセスとして動作し、オーバーヘッドを削減する。

---

## Simulation Master の役割（分散モード）

1. **時間同期とステップ制御**  
   - 全ノードのシミュレーション時間（Δtステップ）を同期。  
   - 各ノードのステップ完了を待機し、次ステップへ進むためのバリア同期を実行。

2. **スナップショット統合と管理**  
   - 各ノードが送信する差分スナップショットを統合し、グローバルスナップショットを生成。  
   - フルスナップショットをRedisにキャッシュし、ノードの再接続やリプレイをサポート。

3. **ノード登録と状態監視**  
   - ノードの接続・切断を追跡し、ハートビートで健全性を監視。  
   - クラッシュノードが再起動した場合、キャッシュスナップショットを利用して迅速に同期復旧。

4. **Behavior Tree (BT) 配布と初期化**  
   - 共通BT XMLを各ノードに配布し、ローカルBTランタイムを初期化。

5. **外部API提供**  
   - gRPCをコアとし、必要に応じてROS2ラッパーを通じて、外部制御、GUI、デバッグツールと連携。

6. **ログとリプレイ管理**  
   - グローバルスナップショットやイベントログを保存し、後からオフライン再生や解析が可能。

---

## シングルモードでの簡略仕様

シングルモードでは、Simulation Master と Node は **1つのプロセス内で統合**され、  
以下のように機能が簡略化される：

- **時間同期やバリア制御を省略**し、Masterが直接 `step(delta_t)` を呼び出す。
- スナップショット統合やRedisキャッシュは不要（単一ノード内で管理）。
- ノード登録・監視機能は無効化（プロセス内部のため不要）。
- BT配布はローカルで直接ロード。
- ログやリプレイはローカルディスクに単純保存。

これにより、**小規模シナリオや開発用デバッグで高いパフォーマンス**を発揮できる。

---

## ノード共通インターフェース

全てのシミュレーションノードは以下の共通APIを実装する：

```python
class SimulationNode:
    def initialize(self, full_snapshot, bt_xml):
        """初期スナップショットをロードし、BTツリーを構築"""
        pass

    def wait_for_sync(self):
        """分散モード: Masterのシグナルを待機してステップ開始。
        シングルモード: 不要。"""
        pass

    def step(self, delta_t):
        """BTをTickし、シミュレーションエンジンのステップを実行"""
        pass

    def collect_asset_states(self):
        """現在のアセット状態を差分スナップショットとして取得"""
        pass

    def send_state_update(self, delta_snapshot):
        """差分スナップショットをMasterに送信（シングルではローカル処理）"""
        pass

    def send_event(self, event):
        """イベントをMasterに送信（シングルではローカル処理）"""
        pass

    def shutdown(self):
        """終了処理として最終スナップショット保存とリソース解放"""
        pass
```

---

## ノード内部ループ設計（例）

### SimPyノード
- SimPyノードは、ロジック中心で軽量なシミュレーションを担当。
- py_treesでBTを処理し、SimPyのEnvironmentで時間を進める。

### Gazeboノード
- Gazeboノードは高精度物理シミュレーションを担当。
- BehaviorTree.CPP でBTを処理し、Gazeboがサブステップで物理演算を行う。

### その他のエンジン（Mujoco, Genesis, Unreal, Isaacなど）
- 上記 SimulationNode インターフェースを実装すればMasterと統合できる。

---

## 分散環境での通信と同期サイクル

1. Masterが各ノードへ「ステップ開始」シグナルを送信。
2. 各ノードが`step(delta_t)`を実行し、BT Tickとシミュレーション更新を行う。
3. ノードが差分スナップショットを生成し、Masterに送信。
4. Masterが統合スナップショットを生成し、必要に応じてキャッシュ・ログ化。
5. バリア同期で全ノードの処理を揃え、次ステップへ進行。

このサイクルにより、**分散環境でも一貫したシミュレーション状態と時間管理**を実現する。
