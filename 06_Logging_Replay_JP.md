# 6. Logging / Replay 仕様

## 目的
本フレームワークの **Logging / Replay 機能** は、シミュレーション実行中の状態やイベントを記録し、
後から **オフラインでの解析・可視化・デバッグ** や **再現テスト** を行うための仕組みを提供する。

---

## ログ構造

### ログの基本単位
1. **フルスナップショット**
   - 特定の時刻 `t` における世界の完全な状態（全アセットの位置、速度、内部状態など）。
   - 定期的（例：1秒ごと）に保存し、リプレイのアンカーとして利用。

2. **差分スナップショット**
   - 前ステップからの変更のみを記録（位置や状態の変化）。
   - 軽量な形式で、フルスナップショット間の補間として利用。

3. **イベントログ**
   - タスク完了、BT状態遷移、エラー発生などの非連続イベントを記録。

---

## ログの保存先
- **Redis キャッシュ**
  - 分散モード時のリアルタイム同期用。
  - ノード障害時の復旧ポイントとしてフルスナップショットをキャッシュ。

- **永続ストレージ**
  - フルスナップショット＋差分スナップショット＋イベントログを順次ファイル保存。
  - 保存形式はJSONまたはバイナリ形式（最適化のため選択可能）。

---

## リプレイ仕様

1. **フルスナップショットをロード**し、対象時刻の世界を初期化。
2. **差分スナップショットを順次適用**し、元のシミュレーション進行を再現。
3. **再生速度の調整**が可能（1x、スロー、早送り）。
4. **イベントのフィルタリング**（特定のタスクやエラーのみ表示）。
5. **GUIでのビジュアル再生**または **CLIでの統計解析**をサポート。

---

## 利用方法

### CLIツール
- `log list`: 利用可能なログ一覧を表示。
- `log replay <log_id>`: ログを再生（テキストまたは簡易ビジュアル）。
- `log export <log_id> --format=csv`: ログを解析用にエクスポート。

### GUIツール
- タイムライン上でのスナップショット再生。
- 差分のハイライト表示。
- イベントフィルタリングや統計ダッシュボード表示。

---

## 実装上のポイント
- フルスナップショットの間隔を調整し、**リプレイ時の負荷とストレージ消費を最適化**。
- 差分は、**アセット単位での変更検出と圧縮**を行い効率化。
- ログ形式は、**シナリオやスナップショット仕様と互換性を持たせる**ことを前提とする。
